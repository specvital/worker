---
title: External Repo ID ë¬´ê²°ì„±
description: External Repository ID ê¸°ë°˜ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ë©”ì»¤ë‹ˆì¦˜
---

# ADR-08: External Repository ID ê¸°ë°˜ ë°ì´í„° ë¬´ê²°ì„±

> ğŸ‡ºğŸ‡¸ [English Version](/en/adr/08-external-repo-id-integrity.md)

| ë‚ ì§œ       | ì‘ì„±ì       | ë¦¬í¬ì§€í† ë¦¬ |
| ---------- | ------------ | ---------- |
| 2024-12-22 | @KubrickCode | all        |

## Context

### ë¬¸ì œ

í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ ì‹ë³„ ë°©ì‹: `UNIQUE (host, owner, name)` ì œì•½ì¡°ê±´ ì‚¬ìš©. ì—¬ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œ ì‹¤íŒ¨:

**ì‹œë‚˜ë¦¬ì˜¤: ì‚­ì œ í›„ ì¬ìƒì„±**

```
1. ë¦¬í¬ A: alice/my-repo (external_repo_id: 100) â†’ ë¶„ì„ ì™„ë£Œ
2. ë¦¬í¬ A ì‚­ì œ
3. ë¦¬í¬ B ìƒì„±: alice/my-repo (external_repo_id: 200)
4. Schedulerê°€ alice/my-repo ì¬ë¶„ì„ ìš”ì²­
5. Clone ì„±ê³µ (ë¦¬í¬ B)
6. ë¶„ì„ ê²°ê³¼ê°€ ë¦¬í¬ Aì˜ rowì— ì €ì¥
   â†’ ë°ì´í„° ì˜¤ì—¼!
```

**ì¶”ê°€ ì‹œë‚˜ë¦¬ì˜¤**

| ì‹œë‚˜ë¦¬ì˜¤                         | ë¬¸ì œ                                    |
| -------------------------------- | --------------------------------------- |
| Rename (alice/old â†’ alice/new)   | ìƒˆ ì´ë¦„ìœ¼ë¡œ ìš”ì²­ ì‹œ íˆìŠ¤í† ë¦¬ ë‹¨ì ˆ       |
| Transfer (alice/repo â†’ bob/repo) | owner ë³€ê²½ ì‹œ íˆìŠ¤í† ë¦¬ ë‹¨ì ˆ             |
| ì‚­ì œ í›„ ì¬ìƒì„±                   | ë‹¤ë¥¸ ë¦¬í¬ ë°ì´í„°ê°€ ê¸°ì¡´ íˆìŠ¤í† ë¦¬ì— ì˜¤ì—¼ |

### ëª©í‘œ

1. **ë°ì´í„° ë¬´ê²°ì„±**: ì˜ëª»ëœ ë¦¬í¬ì§€í† ë¦¬ì˜ ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ëŠ” ê²ƒ ë°©ì§€
2. **íˆìŠ¤í† ë¦¬ ì—°ì†ì„±**: rename/transfer ì‹œ ë¶„ì„ íˆìŠ¤í† ë¦¬ ìœ ì§€
3. **API íš¨ìœ¨ì„±**: VCS API í˜¸ì¶œ ìµœì†Œí™” (rate limit ê³ ë ¤)

## Decision

**ì´ì¤‘ ê²€ì¦ ë©”ì»¤ë‹ˆì¦˜ ì±„íƒ: `external_repo_id`ë¡œ ì‹ë³„ + `git fetch SHA`ë¡œ ë¬´ê²°ì„± ê²€ì¦**

### í•µì‹¬ ì›ì¹™

> **ì¬ë¶„ì„ ì‹œ API í˜¸ì¶œ ì—†ì´ `git fetch <last_commit_sha>`ë¡œ ë¬´ê²°ì„± ê²€ì¦**

### ë©”ì»¤ë‹ˆì¦˜ ì¡°í•©

| ë©”ì»¤ë‹ˆì¦˜               | ìš©ë„                             | API í•„ìš”        |
| ---------------------- | -------------------------------- | --------------- |
| `external_repo_id`     | Rename/Transfer ì‹œ íˆìŠ¤í† ë¦¬ ì—°ê²° | Yes (ì‹ ê·œ ë¶„ì„) |
| `git fetch <sha>` ê²€ì¦ | ê°™ì€ ë¦¬í¬ì¸ì§€ í™•ì¸               | No              |

### git fetch SHA ê²€ì¦

```bash
# ë§ˆì§€ë§‰ìœ¼ë¡œ ë¶„ì„í•œ commitì´ í˜„ì¬ ë¦¬í¬ì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
git fetch --depth 1 origin <last_commit_sha>

# ê²°ê³¼
# - ì„±ê³µ: ê°™ì€ ë¦¬í¬ (í•´ë‹¹ commit ì¡´ì¬)
# - ì‹¤íŒ¨: ë‹¤ë¥¸ ë¦¬í¬ (ì‚­ì œ í›„ ì¬ìƒì„±) ë˜ëŠ” force push
```

**ì—ëŸ¬ ë©”ì‹œì§€** (ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°):

```
fatal: remote error: upload-pack: not our ref <sha>
```

## Options Considered

### Option A: í•­ìƒ VCS API í˜¸ì¶œ (ê¸°ê°)

**ì„¤ëª…:** ëª¨ë“  ë¶„ì„ ì‹œ API í˜¸ì¶œë¡œ ë¦¬í¬ì§€í† ë¦¬ ID í™•ì¸ ë° ê²€ì¦.

**ì¥ì :**

- ë‹¨ìˆœí•œ êµ¬í˜„
- í•­ìƒ ì •í™•

**ë‹¨ì :**

- Rate limit ì†Œì§„ (GitHub 5000/hr)
- ì§€ì—° ì‹œê°„ ì¦ê°€
- ë¹ˆë²ˆí•œ ì¬ë¶„ì„ì— í™•ì¥ì„± ë¶€ì¡±

### Option B: git fetch SHAë§Œ ì‚¬ìš© (ê¸°ê°)

**ì„¤ëª…:** external_repo_id ì—†ì´ git fetch ê²€ì¦ë§Œ ì‚¬ìš©.

**ì¥ì :**

- API í˜¸ì¶œ 0íšŒ
- ë‹¨ìˆœ

**ë‹¨ì :**

- Rename/transfer ê°ì§€ ë¶ˆê°€ (íˆìŠ¤í† ë¦¬ ë‹¨ì ˆ)
- Force pushì™€ ì‚­ì œ í›„ ì¬ìƒì„± êµ¬ë¶„ ë¶ˆê°€

### Option C: ì´ì¤‘ ë©”ì»¤ë‹ˆì¦˜ (ì„ íƒ)

**ì„¤ëª…:** external_repo_id ì €ì¥ê³¼ git fetch SHA ê²€ì¦ ì¡°í•©.

**ì¥ì :**

- í•„ìš” ì‹œì—ë§Œ API í˜¸ì¶œ (ì‹ ê·œ ë¶„ì„, ê²€ì¦ ì‹¤íŒ¨)
- external_repo_idë¡œ rename/transfer ê°ì§€
- Force push vs ì‚­ì œ í›„ ì¬ìƒì„± êµ¬ë¶„
- í™•ì¥ ê°€ëŠ¥ (ëŒ€ë¶€ë¶„ì˜ ì¬ë¶„ì„ì€ API í˜¸ì¶œ ë¶ˆí•„ìš”)

**ë‹¨ì :**

- êµ¬í˜„ ë³µì¡ë„ ì¦ê°€
- ìŠ¤í‚¤ë§ˆ ë³€ê²½ í•„ìš”

## Implementation

### ì¼€ì´ìŠ¤ ë¶„ë¥˜

| ì¼€ì´ìŠ¤ | ì¡°ê±´                               | ê²°ê³¼                 |
| ------ | ---------------------------------- | -------------------- |
| A      | DBì— ì—†ìŒ, external_repo_idë„ ì—†ìŒ | ìƒˆ codebase ìƒì„±     |
| B      | DBì— ìˆìŒ, git fetch ì„±ê³µ          | ê¸°ì¡´ codebase ì¬ë¶„ì„ |
| D      | DBì— ì—†ìŒ, external_repo_idëŠ” ì¡´ì¬ | owner/name ì—…ë°ì´íŠ¸  |
| E      | DBì— ìˆìŒ, git fetch ì‹¤íŒ¨, ID ë‹¤ë¦„ | stale ë§ˆí‚¹ + ìƒˆ ìƒì„± |
| F      | DBì— ìˆìŒ, git fetch ì‹¤íŒ¨, ID ê°™ìŒ | Force push, ì¬ë¶„ì„   |

### íë¦„

```
[ë¶„ì„ ìš”ì²­: owner/repo]
      â”‚
      â”œâ”€ 1. Clone
      â”‚
      â”œâ”€ 2. DB ì¡°íšŒ (owner, repo)
      â”‚      â”‚
      â”‚      â”œâ”€ ì—†ìŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚      â”‚                                     â”‚
      â”‚      â””â”€ ìˆìŒ                               â”‚
      â”‚           â”‚                               â”‚
      â”‚           â”œâ”€ 3. git fetch <last_sha>      â”‚
      â”‚           â”‚      â”‚                        â”‚
      â”‚           â”‚      â”œâ”€ ì„±ê³µ                  â”‚
      â”‚           â”‚      â”‚    â†’ ë¶„ì„ ì§„í–‰         â”‚
      â”‚           â”‚      â”‚                        â”‚
      â”‚           â”‚      â””â”€ ì‹¤íŒ¨                  â”‚
      â”‚           â”‚           â”‚                   â”‚
      â”‚           â”‚           â–¼                   â”‚
      â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                                           â”‚
      â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”‚
      â”‚                       â–¼
      â”‚              4. VCS API í˜¸ì¶œ
      â”‚                 â†’ external_repo_id
      â”‚                       â”‚
      â”‚                       â–¼
      â”‚              5. DB ì¡°íšŒ (external_repo_id)
      â”‚                       â”‚
      â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚              â”‚                 â”‚
      â”‚           ìˆìŒ               ì—†ìŒ
      â”‚              â”‚                 â”‚
      â”‚              â–¼                 â–¼
      â”‚        owner/name         ìƒˆ codebase
      â”‚          ì—…ë°ì´íŠ¸             ìƒì„±
      â”‚              â”‚                 â”‚
      â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                       â”‚
      â”‚                       â–¼
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ 6. ë¶„ì„ & ì €ì¥
```

### ìŠ¤í‚¤ë§ˆ ë³€ê²½

```sql
-- ì»¬ëŸ¼ ì¶”ê°€
ALTER TABLE codebases ADD COLUMN external_repo_id VARCHAR(64);
ALTER TABLE codebases ADD COLUMN is_stale BOOLEAN DEFAULT false;

-- owner/name partial unique ì¸ë±ìŠ¤ (stale ì œì™¸)
CREATE UNIQUE INDEX idx_codebases_owner_name
ON codebases(host, owner, name)
WHERE is_stale = false;

-- external_repo_id unique ì¸ë±ìŠ¤
CREATE UNIQUE INDEX idx_codebases_external_repo_id
ON codebases(host, external_repo_id);
```

**VARCHAR(64) ì„ íƒ ì´ìœ :**

| í”Œë«í¼    | íƒ€ì…    | ì˜ˆì‹œ                                     |
| --------- | ------- | ---------------------------------------- |
| GitHub    | BIGINT  | `123456789`                              |
| GitLab    | INTEGER | `12345678`                               |
| Bitbucket | UUID    | `{550e8400-e29b-41d4-a716-446655440000}` |

ëª¨ë“  íƒ€ì…ì„ ë¬¸ìì—´ë¡œ í†µì¼í•˜ì—¬ ì €ì¥.

### Race Condition ì²˜ë¦¬

**Clone-Rename Race:**

```
T1: Workerê°€ alice/old-repo clone
T2: ì‚¬ìš©ìê°€ alice/old-repo â†’ alice/new-repoë¡œ rename
T3: Workerê°€ clone ì™„ë£Œ (old-repo ì½”ë“œ)
T4: Workerê°€ API í˜¸ì¶œ â†’ external_repo_id: 100
T5: DBì—ì„œ id=100 ì¡°íšŒ â†’ alice/new-repoë¡œ ë³€ê²½ë¨
T6: Workerê°€ old-repo ì½”ë“œë¥¼ new-repoì— ì €ì¥
    â†’ ë°ì´í„° ì˜¤ì—¼!
```

**í•´ê²°ì±…:** Clone ì‹œì ì˜ owner/nameê³¼ API ì¡°íšŒ ê²°ê³¼ ë¹„êµ

```go
if existingCodebase.Owner != req.Owner || existingCodebase.Name != req.Name {
    return ErrRaceConditionDetected // ì¬ì‹œë„ ìœ ë„
}
```

**ë™ì‹œ ë¶„ì„ ìš”ì²­:**

- `(host, external_repo_id)` unique ì œì•½ì¡°ê±´ìœ¼ë¡œ ì¤‘ë³µ ìƒì„± ë°©ì§€
- Application layerì—ì„œ ì¼€ì´ìŠ¤ë³„ ë¶„ë¦¬ ì²˜ë¦¬ (UPSERT ì‚¬ìš© ê¸ˆì§€)

### Stale ì •ì±…

| í•­ëª©      | ê°’                                       |
| --------- | ---------------------------------------- |
| ë³´ì¡´ ê¸°ê°„ | 30ì¼                                     |
| UI í‘œì‹œ   | "ë¦¬í¬ì§€í† ë¦¬ê°€ ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤" |
| ìë™ ì‚­ì œ | 30ì¼ í›„                                  |

## Consequences

### Positive

**ë°ì´í„° ë¬´ê²°ì„±:**

- ì‚­ì œ í›„ ì¬ìƒì„± ì‹œë‚˜ë¦¬ì˜¤ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬
- Force pushì™€ ì‹ë³„ ë³€ê²½ êµ¬ë¶„
- Rename/transfer ì‹œ íˆìŠ¤í† ë¦¬ ë³´ì¡´

**íš¨ìœ¨ì„±:**

- ëŒ€ë¶€ë¶„ì˜ ì¬ë¶„ì„ì€ API í˜¸ì¶œ ë¶ˆí•„ìš”
- Rate limit ë¶€ë‹´ ìµœì†Œí™”
- ìˆ˜ë°±ë§Œ ë¦¬í¬ì§€í† ë¦¬ë¡œ í™•ì¥ ê°€ëŠ¥

**ê²½ìŸ ìš°ìœ„:**

- Codecov/Coverallsì™€ ë‹¬ë¦¬ rename ì‹œ ìë™ íˆìŠ¤í† ë¦¬ ì—°ê²°
- ìˆ˜ë™ ì¬ì„¤ì • ë¶ˆí•„ìš”

### Negative

**ë³µì¡ë„:**

- 6ê°€ì§€ ì¼€ì´ìŠ¤ ë¶„ë¥˜ êµ¬í˜„ í•„ìš”
- ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”
- Race condition ì²˜ë¦¬ í•„ìš”

**ë§ˆì´ê·¸ë ˆì´ì…˜:**

- ê¸°ì¡´ codebaseì— external_repo_id ë°±í•„ í•„ìš”
- ë‹¨ê³„ì  ë°°í¬ í•„ìš” (nullable â†’ ë°±í•„ â†’ NOT NULL)

**í”Œë«í¼ ì˜ì¡´ì„±:**

- Bitbucket Cloud git fetch SHA ì§€ì› ë¶ˆí™•ì‹¤
- GitLab self-hostedëŠ” `uploadpack.allowReachableSHA1InWant` ì„¤ì • í•„ìš”

## í”Œë«í¼ ì§€ì›

| í”Œë«í¼           | git fetch SHA | í…ŒìŠ¤íŠ¸ ê²°ê³¼      |
| ---------------- | ------------- | ---------------- |
| GitHub           | ì§€ì›          | ì§ì ‘ í…ŒìŠ¤íŠ¸ ì™„ë£Œ |
| GitLab           | ì§€ì›          | ì§ì ‘ í…ŒìŠ¤íŠ¸ ì™„ë£Œ |
| Bitbucket Server | ì§€ì› (v5.5+)  | ë¬¸ì„œ í™•ì¸        |
| Bitbucket Cloud  | ë¶ˆí™•ì‹¤        | ì¶”í›„ í…ŒìŠ¤íŠ¸ í•„ìš” |

## API í˜¸ì¶œ ë¹ˆë„

| ì¼€ì´ìŠ¤           | API í˜¸ì¶œ | ë¹ˆë„      |
| ---------------- | -------- | --------- |
| ì‹ ê·œ ë¶„ì„        | 1íšŒ      | ë‚®ìŒ      |
| ì¬ë¶„ì„ (ì •ìƒ)    | 0íšŒ      | ë†’ìŒ      |
| Scheduler (ì •ìƒ) | 0íšŒ      | ë†’ìŒ      |
| ì‚­ì œ í›„ ì¬ìƒì„±   | 1íšŒ      | ë§¤ìš° ë‚®ìŒ |
| Force push       | 1íšŒ      | ë§¤ìš° ë‚®ìŒ |
| Rename/Transfer  | 1íšŒ      | ë§¤ìš° ë‚®ìŒ |

**ëŒ€ë¶€ë¶„ì˜ ì¼€ì´ìŠ¤ì—ì„œ API í˜¸ì¶œ ë¶ˆí•„ìš”** â†’ Rate limit ë¶€ë‹´ ìµœì†Œí™”

## References

- [ADR-07: Repository íŒ¨í„´](./collector/07-repository-pattern.md) - ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™”
- [ADR-05: Worker-Scheduler ë¶„ë¦¬](./collector/05-worker-scheduler-separation.md) - í”„ë¡œì„¸ìŠ¤ ì•„í‚¤í…ì²˜
- [GitHub API Rate Limits](https://docs.github.com/en/rest/rate-limit)
